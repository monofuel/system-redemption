- hosts: all
  become: true
  tasks:
  - name: install useful tools
    apt: name={{item}} state=present
    with_items:
      - vim
      - tmux
      - curl
      - wget
      - git
      - fish
      - htop
      - sudo
      - make
      - python-pip
  - name: create group monofuel
    group:
      name: monofuel
      gid: 1000
      state: present
  - name: Add the user monofuel
    user:
      name: monofuel
      shell: /usr/bin/fish
      comment: The Techromancer
      uid: 1000
      groups: monofuel
      append: yes
  - name: DOCKER SUCKS
    shell: |
      # https://www.linode.com/community/questions/17114/docker-wont-start-using-the-latest-linode-kernel#answer-67343
      # why does it suck so much
      mkdir -p /etc/systemd/system/containerd.service.d/

      cat << EOF > /etc/systemd/system/containerd.service.d/override.conf
      [Service]
      ExecStartPre=

  - name: reload
    shell: systemctl daemon-reload
  - name: check if docker is installed
    shell: command -v docker >/dev/null 2>&1
    register: docker_exists
    ignore_errors: yes
  - name: fetch docker installer
    get_url:
      url: https://get.docker.com
      dest: /tmp/get-docker.sh
      mode: 1770
    when: docker_exists.rc == 1
  - name: install docker
    shell: "/tmp/get-docker.sh"
    when: docker_exists.rc == 1
  - name: start docker
    service:
      name: docker
      enabled: yes
  - name: install docker-compose
    pip:
      name: docker-compose
  - name: add monofuel to docker group
    user:
      name: monofuel
      group: docker
      append: yes
  - name: cleanup
    shell: docker system prune -af
    become: yes
  # deps get copied over by deployment
  #- name: fetch deps
  #  shell: docker run -v /vagrant:/sr node:alpine sh -c 'cd /sr && yarn; chown -R 1000:1000 ./*'
  #  become: yes
  #  become_user: monofuel
  - name: compose build
    shell: docker-compose build
    become: yes
    become_user: monofuel
    args:
      chdir: /vagrant/
  - name: compose up
    shell: docker-compose up -d
    become: yes
    become_user: monofuel
    args:
      chdir: /vagrant/